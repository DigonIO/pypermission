before_script:
  - python --version
  - python ci/secrets.py

stages:
  - analysis
  - documentation
  - testing
  - release

#### analysis ####
pylint_3_10_7:
  stage: analysis
  image: "python:3.10.7-alpine3.16"
  script:
    - pip install .[lint]
    - pylint src
  allow_failure: true

mypy_3_10_7:
  stage: analysis
  image: "python:3.10.7-alpine3.16"
  script:
    - pip install .[lint]
    - mypy src
  allow_failure: true

pydocstyle_3_10_7:
  stage: analysis
  image: "python:3.10.7-alpine3.16"
  script:
    - pip install .[lint]
    - pydocstyle src
  allow_failure: true

bandit_3_10_7:
  stage: analysis
  image: "python:3.10.7-alpine3.16"
  script:
    - pip install .[lint]
    - bandit -r src
  allow_failure: false

#### documentation ####
doc_3_10_7:
  stage: documentation
  image: "python:3.10.7-alpine3.16"
  script:
    - pip install .[doc]
    - sphinx-build -b html docs/ docs/_build/html

#### testing ####
pytest_3_10_7:
  stage: testing
  image: "python:3.10.7-alpine3.16"
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  script:
    - pip install .[test]
    - pytest --cov=src/ tests/

pydoctest_3_10_7:
  stage: testing
  image: "python:3.10.7-alpine3.16"
  script:
    - pip install .[test]
    - pytest --doctest-modules docs/pages/*/*.rst

#### release ####
pypi:
  image: python:3.10.7-bullseye
  stage: release
  script:
    - pip install .[yaml]
    - pip install twine
    - python setup.py sdist bdist_wheel
    - twine upload dist/*
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+.\d+.\d+/'
